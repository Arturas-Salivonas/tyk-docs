---
date: 2021-03-22T10:00:00Z
title: Integrating Tyk with Keycloak using OpenID Connect Dynamic Client Registration
menu:
  main:
    parent: "Tyk Developer Portal"
weight: 2 
url: /tyk-developer-portal/keycloak-dcr
---

## Integrating Tyk with Keycloak using OpenID Connect Dynamic Client Registration

In this guide we’ll walk you through a basic integration of Tyk with Keycloak using the [OpenID Connect Dynamic Client Registration protocol](https://tools.ietf.org/html/rfc7591). Our current implementation provides support for the client credentials flow with support for JWT (JSON Web Tokens). To the developer it look as follows:

An API with its corresponding policy is created in Tyk. It’s also exposed on the developer portal.

A developer signs up and creates a client using the developer portal.
Tyk sends the Dynamic Client Registration call to your identity provider. The IDP replies with the client ID and secret.

Using the previous information, the developer (or your application) triggers a call to the token endpoint of the IDP.
The developer (or your application) triggers a call to Tyk, using the token that was generated by the IDP. Tyk validates this token using the JSON Web Key Sets (JWKS) provided by the IDP.

### Requirements

- A [Keycloak](https://www.keycloak.org/) instace.
- Basic Tyk Setup (gateway + dashboard).

### Getting started with Keycloak

In order to get started with Dynamic Client Registration in Keycloak we’ll need to generate an [initial access token](https://openid.net/specs/openid-connect-registration-1_0.html#Terminology) using the Keycloak Administration Console. After logging in, select the "Realm settings" button under "Configure" and toggle the "Client Registration" tab:

![Step 1](/docs/img/dcr/keycloak/step_1.png)

To generate an initial access token, click on "Create" and set the expiration time and maximum number of clients that can be created using this token:

![Step 2](/docs/img/dcr/keycloak/step_2.png)

After clicking "Save" you will get the token. Keep it handy as we’ll use this token to configure Tyk.

### Setting up Tyk

Now we’re ready to set up Tyk, open the Tyk Dashboard and click on the "APIs" button under "System Management". Create a new API called "Keycloak API":

![Step 3](/docs/img/dcr/keycloak/step_3.png)

After the first part of the API creation form was filled, click on "Configure API" and set the authentication settings as follows:

![Step 4](/docs/img/dcr/keycloak/step_4.png)

**Where to get the proper JWKS URI for your Keycloak environment?**

*The JWKS URI is a required field in the .well-known/openid-configuration endpoint of your OpenID Connect Provider metadata. Please see the spec https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationResponse for further information.*

For the "Identity Source" field use `"sub"` and for "Policy Field Name" use `"pol"`.

Click "Save" and switch to the "Policies" button under "System Management". Once in this section, click on "Create a Policy" and call it "Keycloak Policy", you may use the default values for this one. Remember to select the previously created "Keycloak API" in the access rights section. You will also need to set an expiration setting for the keys.

After the policy is ready, switch back to the API settings and make sure that the API is using the appropriate policy:

![Step 5](/docs/img/dcr/keycloak/step_5.png)

Now we’re ready to add this API to the developer portal. Switch to the "Catalogue" section that’s linked under "Portal Management" on the navigation menu. Once in this section, click on "Add New API", set a name for it and select the newly created policy. For this guide we’re using "Keycloak Policy":

![Step 6](/docs/img/dcr/keycloak/step_6.png)

Hit "Save" and click on the recently created item again, switch to the "Settings" tab that’s next to "API Details". In "API Details" toggle the "Override global settings" option.

**Note:** Tyk lets you set global portal settings that apply to **all portal-listed APIs**, in this guide we assume you’re enabling and setting up DCR for a single API. In case you want to enable DCR for all the APIs, you should refer to the "Settings" button under "Portal Management", in the "API Access" tab you will be able to enter DCR settings as well.

Once the "Override global settings" option is toggled, scroll down to the DCR section in the bottom and enter the following settings:

![Step 7](/docs/img/dcr/keycloak/step_7.png)

**Providers:** Different providers might implement the standard in slightly different ways, Tyk provides a specific driver for each one. For IDPs that aren’t on the list use the "Other" option.

**Grant Types:** OAuth 2.0 grant types that will be used by the client, see the [specification](https://openid.net/specs/openid-connect-registration-1_0.html#rfc.section.2) for more details.

**Token Endpoint Auth Method:** defines the way the client will authenticate against the token endpoint.

**Response Types:** OAuth 2.0 response types that will be used by the client.

**Identity Provider Host:** Base IDP URL, e.g. https://keycloak:8443/

**Client Registration Endpoint:** OpenID Connect client registration endpoint. This value is found in your well-known discovery document as `registration_endpoint`. The well-known location URL is typically https://keycloak:8443/.well-known/openid-configuration

**Initial Registration Access Token:** the token that’s used to register new clients, this was generated in the early steps of the guide.

### Testing the flow

Now that both Tyk and Keycloak are ready we can try the complete flow. Click on the "Developers" button under "Portal Management", then click on "Add developer", enter some basic information here to create a developer user.

After the developer is created, open the portal, click on the "OAuth Clients" navigation bar button and follow the wizard:

![Step 8](/docs/img/dcr/keycloak/step_8.png)

After clicking on "Create first OAuth Client" we’ll see our previously created "Keycloak API", select that one and click on "Save and continue". The following screen will require you to enter a client name. It’s possible to set redirect URLs if you also plan to use this client for other flow types. This setting can be left blank for the purposes of this guide.

![Step 9](/docs/img/dcr/keycloak/step_9.png)

Once you click on "Create", Tyk will trigger a registration on your IDP and the details of your client will show up:

![Step 10](/docs/img/dcr/keycloak/step_10.png)

If you check the Keycloak dashboard you will see this client too:

![Step 11](/docs/img/dcr/keycloak/step_11.png)

The next step is to generate a token and use it for accessing our "Keycloak API", let’s use Postman for this. You will need your token URL which it’s also present in the Well-Known URI of your organization.
For this guide we use https://keycloak:8443/auth/realms/master/protocol/openid-connect/token

Our Postman request should contain the following body, where `"client_id"` and `"client_secret"` are the credentials we got from the developer portal:

![Step 12](/docs/img/dcr/keycloak/step_12.png)

Note that we aren’t using any additional header for this request, the client credentials are enough.

Once we get a response from the IDP, we can copy the `"access_token"` and use it to access our "Keycloak API", this request will be proxied by Tyk:

![Step 13](/docs/img/dcr/keycloak/step_13.png)
